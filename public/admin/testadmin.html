<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - API Tester (Modal Login)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .response-box { max-height: 300px; overflow-y: auto; }
    .loading { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .table-scroll { max-height: 420px; overflow: auto; }
    .modal-backdrop { background: rgba(0,0,0,0.45); }
    .toast { position: fixed; right: 1rem; bottom: 1rem; z-index: 60; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">
  <div class="container mx-auto p-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <h1 class="text-2xl md:text-3xl font-bold">🔧 Admin Dashboard — API Tester</h1>
        <div class="flex gap-3 items-center">
          <div id="tokenDisplay" class="hidden bg-green-50 border border-green-200 rounded-md p-3 text-sm flex items-center gap-3">
            <div>
              <div class="text-xs text-green-700">Token</div>
              <div id="tokenValue" class="font-mono text-xs break-all"></div>
            </div>
            <div class="text-xs text-green-600">Expires: <span id="expiryTime"></span></div>
            <button id="logoutBtn" onclick="adminLogout()" class="ml-4 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Logout</button>
          </div>

          <!-- Login button opens modal -->
          <div id="loginShort" class="flex gap-2 items-center">
            <button id="openLoginModalBtn" onclick="openLoginModal()" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700">🔐 Login</button>
          </div>
        </div>
      </div>
      <p class="mt-3 text-sm text-gray-600">Use this dashboard to view and manage users & products.</p>
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold mb-2">Quick Actions</h2>
        <div class="flex flex-col gap-2">
          <button id="showUsersBtn" onclick="showUsers()" class="w-full bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700">👥 Show Users</button>
          <button id="showProductsBtn" onclick="showProducts()" class="w-full bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700">📦 Show Products</button>
          <button onclick="runAllTests()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-2 rounded">🚀 Run All Tests</button>
          <button onclick="populateWithSampleData()" class="w-full bg-teal-500 text-white px-3 py-2 rounded">📝 Fill Sample Data</button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-4 col-span-2">
        <h2 class="font-semibold mb-2">Search</h2>
        <div class="flex gap-2">
          <input id="globalSearch" type="text" placeholder="Search users/products by name, email, id..." class="flex-1 px-3 py-2 border rounded-md" />
          <button onclick="applySearch()" class="bg-gray-700 text-white px-4 py-2 rounded">Search</button>
          <button onclick="clearSearch()" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
        </div>
      </div>
    </div>

    <!-- Main Panels -->
    <div id="mainArea" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Users Panel -->
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">👥 Users</h3>
          <div class="text-sm text-gray-500">Results: <span id="userCount">0</span></div>
        </div>
        <div class="table-scroll border rounded-md">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Email</th>
                <th class="p-2 text-left">Phone</th>
                <th class="p-2 text-left">Address</th>
                <th class="p-2 text-left">Orders</th>
                <th class="p-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Products Panel -->
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">📦 Products</h3>
          <div class="flex items-center gap-3">
            <div class="text-sm text-gray-500">Results: <span id="productCount">0</span></div>
            <!-- ✅ New button -->
            <button onclick="openCreateProductModal()" 
              class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
              ➕ Create
            </button>
          </div>
        </div>
        <div class="table-scroll border rounded-md">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Description</th>
                <th class="p-2 text-left">Stock</th>
                <th class="p-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Response & Loading -->
    <div class="bg-white rounded-lg shadow p-4 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">📄 API Response</h3>
        <div id="loading" class="hidden flex items-center gap-2 text-blue-600">
          <div class="loading w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
          <span>Loading...</span>
        </div>
      </div>
      <div id="response" class="response-box bg-gray-50 border border-gray-200 rounded-md p-4 font-mono text-sm whitespace-pre-wrap"></div>
      <div class="flex gap-2 mt-4">
        <button onclick="clearResponse()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">🗑️ Clear</button>
        <button onclick="copyResponse()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">📋 Copy</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Admin Login</h3>
        <button class="text-gray-600 hover:text-gray-900" onclick="closeLoginModal()">✕</button>
      </div>

      <form id="loginForm" onsubmit="event.preventDefault(); submitLogin();" class="space-y-3">
        <div>
          <label class="block text-sm">Admin ID
            <input id="modalAdminId" class="w-full px-3 py-2 border rounded mt-1" type="text" required />
          </label>
        </div>
        <div>
          <label class="block text-sm">Password
            <input id="modalAdminPassword" class="w-full px-3 py-2 border rounded mt-1" type="password" required />
          </label>
        </div>

        <div id="loginError" class="text-sm text-red-600"></div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeLoginModal()" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
          <button id="loginSubmitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Edit Modal (keeps previous modal) -->
  <div id="userEditModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Edit User</h3>
        <button class="text-gray-600 hover:text-gray-900" onclick="closeUserModal()">✕</button>
      </div>

      <form id="userEditForm" onsubmit="event.preventDefault(); submitUserEdit();" class="space-y-3">
        <input type="hidden" id="editUserId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="block text-sm">Name
            <input id="editUserName" class="w-full px-3 py-2 border rounded" type="text" />
          </label>
          <label class="block text-sm">Email
            <input id="editUserEmail" class="w-full px-3 py-2 border rounded" type="email" />
          </label>
          <label class="block text-sm">Phone
            <input id="editUserPhone" class="w-full px-3 py-2 border rounded" type="tel" />
          </label>
          <label class="block text-sm">Address
            <input id="editUserAddress" class="w-full px-3 py-2 border rounded" type="text" />
          </label>
        </div>

        <div id="userEditErrors" class="text-sm text-red-600"></div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeUserModal()" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
          <button id="userUpdateBtn" type="submit" class="px-4 py-2 rounded bg-green-600 text-white">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Product Edit Modal -->
  <div id="productEditModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Edit Product</h3>
        <button class="text-gray-600 hover:text-gray-900" onclick="closeProductModal()">✕</button>
      </div>

      <form id="productEditForm" onsubmit="event.preventDefault(); submitProductEdit();" class="space-y-3">
        <input type="hidden" id="editProductId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="block text-sm">Name
            <input id="editProductName" class="w-full px-3 py-2 border rounded" type="text" />
          </label>
          <label class="block text-sm">Stock
            <input id="editProductStock" class="w-full px-3 py-2 border rounded" type="number" />
          </label>
          <label class="block text-sm md:col-span-2">Description
            <textarea id="editProductDescription" class="w-full px-3 py-2 border rounded" rows="4"></textarea>
          </label>
        </div>

        <div id="productEditErrors" class="text-sm text-red-600"></div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeProductModal()" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
          <button id="productUpdateBtn" type="submit" class="px-4 py-2 rounded bg-green-600 text-white">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Product Modal -->
  <div id="productCreateModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Create Product</h3>
        <button class="text-gray-600 hover:text-gray-900" onclick="closeCreateProductModal()">✕</button>
      </div>
  
      <form id="productCreateForm" onsubmit="event.preventDefault(); submitCreateProduct();" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="block text-sm">Name
            <input id="createProductName" class="w-full px-3 py-2 border rounded" type="text" required />
          </label>
          <label class="block text-sm">Price
            <input id="createProductPrice" class="w-full px-3 py-2 border rounded" type="number" min="0" required />
          </label>
          <label class="block text-sm">Stock
            <input id="createProductStock" class="w-full px-3 py-2 border rounded" type="number" min="0" required />
          </label>
          <label class="block text-sm">Image URL
            <input id="createProductImage" class="w-full px-3 py-2 border rounded" type="text" />
          </label>
          <label class="block text-sm md:col-span-2">Description
            <textarea id="createProductDescription" class="w-full px-3 py-2 border rounded" rows="4" required></textarea>
          </label>
        </div>
  
        <div id="productCreateErrors" class="text-sm text-red-600"></div>
  
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeCreateProductModal()" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Create</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script>
    let adminToken = null;
    
    const baseUrl = window.location.origin;

    // Loading / Response helpers
    function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
    function displayResponse(data, status = 'success') {
      hideLoading();
      const responseEl = document.getElementById('response');
      const timestamp = new Date().toLocaleTimeString();
      const statusColor = status === 'error' ? '🔴' : '🟢';
      responseEl.textContent = `${statusColor} [${timestamp}]\n${JSON.stringify(data, null, 2)}`;
    }
    function clearResponse() { document.getElementById('response').textContent = ''; }
    function showToast(message, kind = 'success') {
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="max-w-sm w-full ${kind === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white p-3 rounded shadow">${message}</div>`;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 3500);
    }

    // Robust token extraction from response body or headers
    function extractTokenFromResponse(res, body) {
      if (!res) return null;
      const candidates = [body?.token, body?.adminToken, body?.accessToken, body?.tokenValue, body?.data?.token];
      for (const c of candidates) if (c && typeof c === 'string') return c;

      const auth = res.headers.get('authorization') || res.headers.get('Authorization');
      if (auth) {
        if (auth.startsWith('Bearer ')) return auth.replace('Bearer ', '').trim();
        return auth.trim();
      }
      const x = res.headers.get('x-admin-token') || res.headers.get('x-admin-token'.toLowerCase());
      if (x) return x.trim();
      return null;
    }

    function showTokenUI(token, expiresAt) {
      if (!token) return;
      adminToken = token;
      try { localStorage.setItem('adminToken', token); } catch (e) { /* ignore */ }
      document.getElementById('tokenValue').textContent = token;
      const expiryText = expiresAt ? new Date(expiresAt).toLocaleString() : new Date(Date.now() + 2*60*60*1000).toLocaleString();
      document.getElementById('expiryTime').textContent = expiryText;
      document.getElementById('tokenDisplay').classList.remove('hidden');
      document.getElementById('loginShort').classList.add('hidden');
    }

    // LOGIN MODAL controls
    function openLoginModal() {
      document.getElementById('loginError').textContent = '';
      document.getElementById('modalAdminId').value = '';
      document.getElementById('modalAdminPassword').value = '';
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('modalAdminId').focus();
    }
    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
    }

    // updated submitLogin - tolerant to token location
    async function submitLogin() {
      const adminId = document.getElementById('modalAdminId').value.trim();
      const adminPassword = document.getElementById('modalAdminPassword').value;

      if (!adminId || !adminPassword) {
        document.getElementById('loginError').textContent = 'Please enter admin ID and password';
        return;
      }
      document.getElementById('loginError').textContent = '';

      showLoading();
      try {
        const res = await fetch(`${baseUrl}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminId, adminPassword })
        });

        let data = {};
        try { data = await res.json(); } catch (e) { data = {}; }
        displayResponse({ status: res.status, ...data }, res.ok ? 'success' : 'error');

        const token = extractTokenFromResponse(res, data);
        const expiresAt = data?.expiresAt || data?.expires_at || data?.expires || null;

        if (res.ok && token) {
          showTokenUI(token, expiresAt);
          closeLoginModal();
          showToast('Logged in', 'success');
          return;
        }

        if (res.ok && data?.success === true) {
          if (token) {
            showTokenUI(token, expiresAt);
            closeLoginModal();
            showToast('Logged in', 'success');
            return;
          }
          // server accepted but no token visible to frontend
          document.getElementById('loginError').textContent = 'Login OK but no token returned by server';
          showToast('Login OK but no token returned', 'error');
          console.warn('Login response had no token (body, headers):', data, {
            authHeader: res.headers.get('authorization'),
            xAdminToken: res.headers.get('x-admin-token')
          });
          return;
        }

        const errMsg = data?.error || data?.message || (res.status === 401 ? 'Invalid credentials' : 'Login failed');
        document.getElementById('loginError').textContent = errMsg;
        showToast(errMsg, 'error');

      } catch (err) {
        displayResponse({ error: err.message }, 'error');
        document.getElementById('loginError').textContent = 'Network error';
        showToast('Network error', 'error');
      } finally {
        hideLoading();
      }
    }

    // Auth logout - clear localStorage and inform server if possible
    async function adminLogout() {
      const tokenToSend = adminToken || (() => { try { return localStorage.getItem('adminToken'); } catch(e){ return null } })();
      if (!tokenToSend) {
        adminToken = null;
        try { localStorage.removeItem('adminToken'); } catch (e) {}
        document.getElementById('tokenDisplay').classList.add('hidden');
        document.getElementById('loginShort').classList.remove('hidden');
        showToast('Logged out', 'success');
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/api/admin/logout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tokenToSend}` }
        });
        let data = {};
        try { data = await res.json(); } catch (e) { data = {}; }
        displayResponse({ status: res.status, ...data }, res.ok ? 'success' : 'error');
      } catch (err) {
        displayResponse({ error: err.message }, 'error');
      } finally {
        adminToken = null;
        try { localStorage.removeItem('adminToken'); } catch (e) {}
        document.getElementById('tokenDisplay').classList.add('hidden');
        document.getElementById('loginShort').classList.remove('hidden');
        showToast('Logged out', 'success');
      }
    }

    // Generic request helper (uses persisted token if available)
    async function makeRequest(endpoint, options = {}) {
      const tokenToUse = adminToken || (() => { try { return localStorage.getItem('adminToken'); } catch(e){ return null } })();
      if (!tokenToUse) {
        showToast('Please login first', 'error');
        return null;
      }
      showLoading();
      try {
        const url = endpoint.startsWith('http') ? endpoint : `${baseUrl}${endpoint}`;
        const res = await fetch(url, {
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tokenToUse}`, ...(options.headers || {}) },
          ...options
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (e) { data = { text }; }
        displayResponse({ status: res.status, ...data }, res.ok ? 'success' : 'error');
        return { ok: res.ok, status: res.status, data };
      } catch (err) {
        displayResponse({ error: err.message }, 'error');
        showToast('Network error', 'error');
        return { ok: false, status: 0, data: { error: err.message } };
      } finally {
        hideLoading();
      }
    }

    // USERS & PRODUCTS code (unchanged behavior as previous)
    let usersCache = [];
    let productsCache = [];

    async function showUsers() {
      if (!adminToken && !localStorage.getItem('adminToken')) return showToast('Login required', 'error');
      const result = await makeRequest('/api/admin/userdetails');
      if (!result || !result.ok) return;
      const payload = result.data;
      const users = payload.users || payload.data || (Array.isArray(payload) ? payload : []);
      usersCache = users;
      renderUsers(users);
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      document.getElementById('userCount').textContent = users.length || 0;
      if (!users || users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-sm text-gray-500">No users found</td></tr>`;
        return;
      }

      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const userId = u.userId ?? u.id ?? u._id ?? '';
        const name = u.userName ?? u.name ?? '';
        const email = u.userEmail ?? u.email ?? '';
        const phone = u.userPhone ?? u.phone ?? '';
        const address = u.userAddress ?? u.address ?? '';
        const ordersCount = (u.orders && u.orders.length) || u.totalOrders || u._count?.orders || '—';

        tr.innerHTML = `
          <td class="p-2 align-top">${userId}</td>
          <td class="p-2 align-top">${escapeHtml(name)}</td>
          <td class="p-2 align-top">${escapeHtml(email)}</td>
          <td class="p-2 align-top">${escapeHtml(phone)}</td>
          <td class="p-2 align-top">${escapeHtml(address)}</td>
          <td class="p-2 align-top text-sm">${ordersCount}</td>
          <td class="p-2 align-top">
            <div class="flex gap-2">
              <button class="px-2 py-1 bg-blue-500 text-white text-xs rounded" onclick="goToOrdersPage('${userId}')">View Orders</button>
              <button class="px-2 py-1 bg-yellow-500 text-white text-xs rounded" onclick="openUserModal('${userId}')">Edit</button>
              <button class="px-2 py-1 bg-red-500 text-white text-xs rounded" onclick="deleteUserAction('${userId}', this)">Delete</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);

        const ordersRow = document.createElement('tr');
        ordersRow.className = 'orders-row hidden bg-gray-50';
        ordersRow.innerHTML = `<td colspan="7" class="p-2"><div id="orders-for-${userId}" class="text-sm text-gray-700"></div></td>`;
        tbody.appendChild(ordersRow);
      });
    }

    async function viewOrders(userId, btn) {
      const container = document.getElementById(`orders-for-${userId}`);
      if (!container) return;
      const row = btn.closest('tr').nextElementSibling;
      if (!row) return;
      if (!row.classList.contains('hidden')) {
        row.classList.add('hidden');
        return;
      }
      row.classList.remove('hidden');
      container.textContent = 'Loading orders...';

      const res = await makeRequest(`/api/admin/orders?userId=${encodeURIComponent(userId)}`);
      if (!res || !res.ok) {
        container.textContent = 'Could not load orders. See response panel.';
        return;
      }
      const orders = res.data.orders || res.data || [];
      if (!orders || orders.length === 0) {
        container.textContent = 'No orders found for this user.';
        return;
      }

      const html = ['<div class="space-y-2">'];
      orders.forEach(o => {
        html.push(`<div class="p-2 border rounded text-sm"><strong>Order ID:</strong> ${o.orderId ?? o.id ?? ''} — <strong>Total:</strong> ${o.total ?? o.amount ?? '—'}
          <div class="text-xs text-gray-600 mt-1">${escapeHtml(JSON.stringify(o.items || o.products || [], null, 2))}</div>
        </div>`);
      });
      html.push('</div>');
      container.innerHTML = html.join('');
    }

    function openUserModal(userId) {
      const user = usersCache.find(u => (u.userId ?? u.id ?? u._id) == userId);
      if (!user) return showToast('User not found', 'error');
      document.getElementById('editUserId').value = userId;
      document.getElementById('editUserName').value = user.userName ?? user.name ?? '';
      document.getElementById('editUserEmail').value = user.userEmail ?? user.email ?? '';
      document.getElementById('editUserPhone').value = user.userPhone ?? user.phone ?? '';
      document.getElementById('editUserAddress').value = user.userAddress ?? user.address ?? '';
      document.getElementById('userEditErrors').textContent = '';
      document.getElementById('userEditModal').classList.remove('hidden');
    }

    function closeUserModal() { document.getElementById('userEditModal').classList.add('hidden'); }

    async function submitUserEdit() {
      const userId = document.getElementById('editUserId').value;
      const userName = document.getElementById('editUserName').value.trim();
      const userEmail = document.getElementById('editUserEmail').value.trim();
      const userPhoneRaw = document.getElementById('editUserPhone').value.trim();
      const userAddress = document.getElementById('editUserAddress').value.trim();

      // client-side validation
      const errors = [];
      if (userEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(userEmail)) errors.push('Invalid email format');
      if (userPhoneRaw && isNaN(userPhoneRaw)) errors.push('Phone must be numeric');
      if (errors.length) {
        document.getElementById('userEditErrors').textContent = errors.join(' • ');
        return;
      }

      const body = {};
      if (userName !== '') body.userName = userName;
      if (userEmail !== '') body.userEmail = userEmail;
      body.userPhone = userPhoneRaw === '' ? null : Number(userPhoneRaw);
      body.userAddress = userAddress === '' ? null : userAddress;

      const res = await makeRequest(`/api/admin/userid?userId=${encodeURIComponent(userId)}`, {
        method: 'PUT',
        body: JSON.stringify(body)
      });
      if (res && res.ok) {
        const user = usersCache.find(u => (u.userId ?? u.id ?? u._id) == userId);
        if (user) Object.assign(user, body);
        renderUsers(usersCache);
        closeUserModal();
        showToast('User updated', 'success');
      } else {
        showToast('Failed to update user', 'error');
      }
    }

    async function deleteUserAction(userId) {
      if (!confirm(`Are you sure you want to delete user ${userId}? This is irreversible.`)) return;
      const res = await makeRequest(`/api/admin/userid?userId=${encodeURIComponent(userId)}`, { method: 'DELETE' });
      if (res && res.ok) {
        usersCache = usersCache.filter(u => (u.userId ?? u.id ?? u._id) != userId);
        renderUsers(usersCache);
        showToast('User deleted', 'success');
      } else {
        showToast('Failed to delete user', 'error');
      }
    }

    // Products
    async function showProducts() {
      if (!adminToken && !localStorage.getItem('adminToken')) return showToast('Login required', 'error');
      const res = await makeRequest('/api/admin/products');
      if (!res || !res.ok) return;
      const payload = res.data;
      const products = Array.isArray(payload) ? payload : (payload.products || payload.data || []);
      productsCache = products;
      renderProducts(products);
    }

    function renderProducts(products) {
      const tbody = document.getElementById('productsTableBody');
      tbody.innerHTML = '';
      document.getElementById('productCount').textContent = products.length || 0;
      if (!products || products.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-sm text-gray-500">No products found</td></tr>`;
        return;
      }

      products.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const id = p.productId ?? p.id ?? '';
        const name = p.productName ?? p.name ?? '';
        const desc = p.productDescription ?? p.description ?? '';
        const stock = p.productStock ?? p.Stock ?? p.stock ?? 0;

        tr.innerHTML = `
          <td class="p-2 align-top">${id}</td>
          <td class="p-2 align-top"><div class="product-name text-sm break-words">${escapeHtml(name)}</div></td>
          <td class="p-2 align-top"><div class="product-desc text-sm break-words">${escapeHtml(desc)}</div></td>
          <td class="p-2 align-top">
            <input data-id="${id}" class="stock-input px-2 py-1 border rounded w-24 text-sm" value="${escapeHtml(String(stock))}" />
          </td>
          <td class="p-2 align-top">
            <div class="flex gap-2">
              <button class="px-2 py-1 bg-yellow-500 text-white text-xs rounded" onclick="saveProduct('${id}', this)">Save</button>
              <button class="px-2 py-1 bg-blue-500 text-white text-xs rounded" onclick="openProductModal('${id}')">Edit</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // save inline stock via PATCH /api/admin/products/<id>
    async function saveProduct(id, btn) {
      const input = document.querySelector(`.stock-input[data-id="${id}"]`);
      if (!input) return showToast('Stock input not found', 'error');
      const stockVal = input.value.trim();
      if (stockVal === '' || isNaN(stockVal)) return showToast('Stock must be numeric', 'error');

      const res = await makeRequest(`/api/admin/products/${encodeURIComponent(id)}`, {
        method: 'PATCH',
        body: JSON.stringify({ productStock: Number(stockVal) })
      });
      if (res && res.ok) {
        const prod = productsCache.find(p => (p.productId ?? p.id ?? '') == id);
        if (prod) prod.productStock = Number(stockVal);
        renderProducts(productsCache);
        showToast('Stock updated', 'success');
      } else {
        showToast('Failed to update stock', 'error');
      }
    }

    function openProductModal(id) {
      const prod = productsCache.find(p => (p.productId ?? p.id ?? '') == id);
      if (!prod) return showToast('Product not found', 'error');
      document.getElementById('editProductId').value = id;
      document.getElementById('editProductName').value = prod.productName ?? prod.name ?? '';
      document.getElementById('editProductDescription').value = prod.productDescription ?? prod.description ?? '';
      document.getElementById('editProductStock').value = prod.productStock ?? prod.Stock ?? prod.stock ?? 0;
      document.getElementById('productEditErrors').textContent = '';
      document.getElementById('productEditModal').classList.remove('hidden');
    }

    function closeProductModal() { document.getElementById('productEditModal').classList.add('hidden'); }

    async function submitProductEdit() {
      const id = document.getElementById('editProductId').value;
      const name = document.getElementById('editProductName').value.trim();
      const desc = document.getElementById('editProductDescription').value.trim();
      const stockRaw = document.getElementById('editProductStock').value.trim();

      // client-side validation
      const errors = [];
      if (!name) errors.push('Name is required');
      if (stockRaw !== '' && isNaN(stockRaw)) errors.push('Stock must be numeric');
      if (errors.length) {
        document.getElementById('productEditErrors').textContent = errors.join(' • ');
        return;
      }

      const body = {};
      if (name !== '') body.productName = name;
      body.productDescription = desc === '' ? null : desc;
      body.productStock = stockRaw === '' ? null : Number(stockRaw);

      const res = await makeRequest(`/api/admin/products/${encodeURIComponent(id)}`, {
        method: 'PATCH',
        body: JSON.stringify(body)
      });
      if (res && res.ok) {
        const prod = productsCache.find(p => (p.productId ?? p.id ?? '') == id);
        if (prod) Object.assign(prod, body);
        renderProducts(productsCache);
        closeProductModal();
        showToast('Product updated', 'success');
      } else {
        showToast('Failed to update product', 'error');
      }
    }
    function openCreateProductModal() {
  document.getElementById('createProductName').value = '';
  document.getElementById('createProductPrice').value = '';
  document.getElementById('createProductDescription').value = '';
  document.getElementById('createProductStock').value = '';
  document.getElementById('createProductImage').value = '';
  document.getElementById('productCreateErrors').textContent = '';
  document.getElementById('productCreateModal').classList.remove('hidden');
}

function closeCreateProductModal() {
  document.getElementById('productCreateModal').classList.add('hidden');
}

async function submitCreateProduct() {
  const name = document.getElementById('createProductName').value.trim();
  const price = document.getElementById('createProductPrice').value.trim();
  const desc = document.getElementById('createProductDescription').value.trim();
  const stockRaw = document.getElementById('createProductStock').value.trim();
  const image = document.getElementById('createProductImage').value.trim();

  const errors = [];
  if (!name) errors.push('Name is required');
  if (!price || isNaN(price) || Number(price) < 0) errors.push('Valid price is required');
  if (!desc) errors.push('Description is required');
  if (!stockRaw || isNaN(stockRaw) || Number(stockRaw) < 0) errors.push('Valid stock is required');
  
  if (errors.length) {
    document.getElementById('productCreateErrors').textContent = errors.join(' • ');
    return;
  }

  try {
    const response = await fetch('/api/admin/products', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      },
      body: JSON.stringify({
        productName: name,
        productDescription: desc,
        productPrice: Number(price),
        productStock: Number(stockRaw),
        productImage: image || null
      })
    });

    const data = await response.json();
    
    if (!response.ok || data.error) {
      document.getElementById('productCreateErrors').textContent = data.error || 'Failed to create product';
      showToast('Error: ' + (data.error || 'Failed to create product'), 'error');
    } else {
      showToast('✅ Product created successfully!', 'success');
      productsCache.push(data);
      renderProducts(productsCache);
      closeCreateProductModal();
    }
  } catch (error) {
    showToast('Network error: ' + error.message, 'error');
    document.getElementById('productCreateErrors').textContent = 'Network error occurred';
  }
}

    // Search helpers
    function goToOrdersPage(userId) {
      const url = userId ? `/admin/orders.html?userId=${encodeURIComponent(userId)}` : '/admin/orders.html';
      // preserve token by keeping it in localStorage (already done). Redirect now.
      window.location.href = url;
    }

    function applySearch() {
      const q = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
      if (!q) return showToast('Enter search query', 'error');
      if (usersCache.length) {
        const filteredU = usersCache.filter(u => {
          const s = `${u.userId ?? u.id ?? ''} ${u.userName ?? u.name ?? ''} ${u.userEmail ?? u.email ?? ''} ${u.userPhone ?? ''}`.toLowerCase();
          return s.includes(q);
        });
        renderUsers(filteredU);
      }
      if (productsCache.length) {
        const filteredP = productsCache.filter(p => {
          const s = `${p.productId ?? p.id ?? ''} ${p.productName ?? p.name ?? ''} ${p.productDescription ?? p.description ?? ''}`.toLowerCase();
          return s.includes(q);
        });
        renderProducts(filteredP);
      }
    }
    function clearSearch() { document.getElementById('globalSearch').value = ''; if (usersCache.length) renderUsers(usersCache); if (productsCache.length) renderProducts(productsCache); }

    // Test suite & misc (kept)
    async function runAllTests() {
      displayResponse({ message: '🚀 Starting comprehensive test suite...' });
      if (!adminToken) return showToast('Please login first', 'error');
      const uRes = await makeRequest('/api/admin/userdetails');
      if (uRes && uRes.ok) {
        const users = uRes.data.users || uRes.data || [];
        if (users.length > 0) {
          const userId = users[0].userId ?? users[0].id ?? '';
          await makeRequest(`/api/admin/userid?userId=${encodeURIComponent(userId)}`);
          await new Promise(r => setTimeout(r, 600));
          await makeRequest(`/api/admin/userid?userId=${encodeURIComponent(userId)}`, { method: 'PUT', body: JSON.stringify({ userName: 'Test Suite User ' + Date.now() }) });
        }
      }
      await new Promise(r => setTimeout(r, 500));
      await makeRequest('/api/admin/products/stock?id=1', { method: 'PATCH', body: JSON.stringify({ Stock: 50 }) });
      showToast('Test suite completed', 'success');
    }

    function populateWithSampleData() { document.getElementById('globalSearch').value = ''; showToast('Sample data loaded', 'success'); }

    // helper escape
    function escapeHtml(str) { if (str === null || str === undefined) return ''; return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }

    // init - restore token if present
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const saved = localStorage.getItem('adminToken');
        if (saved) showTokenUI(saved, null);
      } catch (e) { /* ignore */ }
      displayResponse({ message: '👋 Welcome! Click Login to open the admin login modal.' });
    });

    // close modals on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLoginModal();
        closeUserModal();
        closeProductModal();
      }
    });
  </script>
</body>
</html>

