<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .scroll-y { max-height: 60vh; overflow-y: auto; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">üßæ Orders</h1>
        <p class="text-sm text-gray-500">Nicely formatted order details ‚Äî click an order to expand items.</p>
      </div>
      <div class="flex gap-2 items-center">
        <button id="backBtn" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">‚Üê Back</button>
        <div id="loginHint" class="text-sm text-red-600 hidden">Please login from the Admin Dashboard first.</div>
      </div>
    </div>

    <div class="flex gap-4 mb-4">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Filter:</span>
        <select id="statusFilter" class="px-2 py-1 border rounded">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <div class="flex items-center gap-2 ml-auto">
        <input id="searchOrders" placeholder="Search order id / user / product..." class="px-3 py-1 border rounded" />
        <button id="applyFilter" class="px-3 py-1 bg-blue-600 text-white rounded">Apply</button>
        <button id="refreshBtn" class="px-3 py-1 bg-gray-200 rounded">Refresh</button>
      </div>
    </div>

    <div id="ordersContainer" class="space-y-4">
      <!-- Order cards will be injected here -->
    </div>

    <div id="emptyState" class="hidden mt-6 p-4 bg-white border rounded text-center text-gray-600">No orders found.</div>

    <div class="mt-6">
      <h2 class="text-lg font-semibold mb-2">Raw API Response</h2>
      <pre id="rawResponse" class="bg-white p-3 border rounded text-xs font-mono whitespace-pre-wrap max-h-48 overflow-auto"></pre>
    </div>
  </div>

  <script>
    const baseUrl = window.location.origin;
    const params = new URLSearchParams(window.location.search);
    const requestedUserId = params.get('userId');

    // token stored in localStorage by testadmin.html flow
    let adminToken = null;
    try { adminToken = localStorage.getItem('adminToken'); } catch(e) { adminToken = null; }

    document.getElementById('backBtn').addEventListener('click', () => {
      window.history.back();
    });

    document.getElementById('refreshBtn').addEventListener('click', loadOrders);
    document.getElementById('applyFilter').addEventListener('click', loadOrders);

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function formatCurrency(n) {
      try { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(Number(n || 0)); }
      catch { return String(n || 0); }
    }

    function formatDate(iso) {
      if (!iso || iso === null || iso === undefined) return '‚Äî';
      
      // Handle case where iso is an empty object or invalid
      if (typeof iso === 'object' && Object.keys(iso).length === 0) {
        return '‚Äî';
      }
      
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '‚Äî';
        return d.toLocaleString();
      } catch (error) {
        console.warn('Date formatting error:', error, 'Input:', iso);
        return '‚Äî';
      }
    }

    function showLoginHint() {
      document.getElementById('loginHint').classList.remove('hidden');
    }

    async function apiGET(path) {
      if (!adminToken) {
        showLoginHint();
        return { ok: false, status: 401, data: { error: 'Missing admin token' } };
      }
      try {
        const res = await fetch(path, {
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` }
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (e) { data = { text }; }
        return { ok: res.ok, status: res.status, data };
      } catch (err) {
        return { ok: false, status: 0, data: { error: err.message } };
      }
    }

    async function loadOrders() {
      const status = document.getElementById('statusFilter').value;
      const q = (document.getElementById('searchOrders').value || '').trim().toLowerCase();

      let endpoint = '/api/admin/orders';
      if (requestedUserId) endpoint += `?userId=${encodeURIComponent(requestedUserId)}`;
      if (status) endpoint += (endpoint.includes('?') ? '&' : '?') + `status=${encodeURIComponent(status)}`;

      console.log('üì° Fetching orders from:', endpoint);
      const res = await apiGET(baseUrl + endpoint);
      document.getElementById('rawResponse').textContent = JSON.stringify(res, null, 2);

      console.log('üì° Full API Response:', res);

      if (!res.ok) {
        console.error('‚ùå API request failed:', res);
        document.getElementById('ordersContainer').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }

      console.log('üìä API Response Data:', res.data);
      console.log('üìä API Response Success:', res.data?.success);
      console.log('üìä API Response Orders:', res.data?.orders);

      // ‚úÖ FIXED: Extract orders from the correct API response structure
      let orders = [];
      
      if (res.data && res.data.orders && Array.isArray(res.data.orders)) {
        orders = res.data.orders;
        console.log('‚úÖ Extracted orders from res.data.orders:', orders.length);
      } else if (res.data && Array.isArray(res.data)) {
        orders = res.data;
        console.log('‚úÖ Extracted orders from res.data:', orders.length);
      } else {
        console.warn('‚ö†Ô∏è Unexpected API response structure:', res.data);
        console.warn('‚ö†Ô∏è Type of res.data:', typeof res.data);
        console.warn('‚ö†Ô∏è res.data.orders exists:', !!res.data?.orders);
        console.warn('‚ö†Ô∏è res.data.orders is array:', Array.isArray(res.data?.orders));
        orders = [];
      }

      console.log(`üì¶ Extracted ${orders.length} orders for rendering`);
      console.log('üì¶ Orders array:', orders);

      // client-side search filter
      if (q) {
        console.log('üîç Applying search filter for:', q);
        const originalCount = orders.length;
        
        orders = orders.filter(o => {
          // ‚úÖ FIXED: Updated field mapping to match API response
          const orderId = o.orderId || '';
          const userInfo = o.user || {};
          const userName = userInfo.userName || userInfo.name || '';
          const userEmail = userInfo.userEmail || userInfo.email || '';
          const items = o.items || [];
          const itemNames = items.map(i => i.productName || i.name || '').join(' ');
          
          const searchString = `${orderId} ${userName} ${userEmail} ${itemNames}`.toLowerCase();
          const matches = searchString.includes(q);
          
          console.log(`üîç Order ${orderId} search check:`, {
            searchString,
            query: q,
            matches
          });
          
          return matches;
        });
        
        console.log(`üîç After search filter: ${orders.length} orders (was ${originalCount})`);
      }

      console.log('üé® About to call renderOrders with:', orders);
      renderOrders(orders);
    }

    function buildItemRow(item) {
      const name = escapeHtml(item.productName || item.name || 'Unnamed');
      const sku = escapeHtml(item.productId || item.sku || '');
      const qty = item.quantity || item.qty || 0;
      const unit = item.unitPrice || item.price || 0;
      const lineTotal = item.lineTotal || (qty * unit) || 0;
      
      return `
        <tr class="border-b">
          <td class="p-2 text-sm">${name}<div class="text-xs text-gray-500">ID: ${sku}</div></td>
          <td class="p-2 text-sm text-center">${qty}</td>
          <td class="p-2 text-sm text-right">${formatCurrency(unit)}</td>
          <td class="p-2 text-sm text-right font-semibold">${formatCurrency(lineTotal)}</td>
        </tr>
      `;
    }

    function renderOrders(orders) {
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';

      console.log('üé® renderOrders called with:', orders);
      console.log('üé® renderOrders - orders length:', orders?.length);
      console.log('üé® renderOrders - orders is array:', Array.isArray(orders));
      console.log('üé® renderOrders - typeof orders:', typeof orders);

      if (!orders || orders.length === 0) {
        console.log('üì≠ No orders to display - showing empty state');
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      } else {
        console.log('üì¶ Orders available - hiding empty state');
        document.getElementById('emptyState').classList.add('hidden');
      }

      console.log('üé® Starting to process orders...');

      orders.forEach((o, index) => {
        console.log(`üîç Processing order ${index + 1}/${orders.length}:`, o);
        
        try {
          // ‚úÖ FIXED: Updated field mapping to match API response structure
          const orderId = o.orderId || o.id || o._id || '‚Äî';
          const userInfo = o.user || {};
          const userName = userInfo.userName || userInfo.name || userInfo.customerName || 'Unknown';
          const userPhone = userInfo.userPhone || userInfo.phone || '';
          const userAddress = userInfo.userAddress || userInfo.address || o.shippingAddress || '';
          const userEmail = userInfo.userEmail || userInfo.email || '';
          
          // ‚úÖ FIXED: Better handling of orderDate
          let orderDate = o.orderDate || o.created_at || o.date || null;
          
          // Handle case where orderDate is an empty object
          if (orderDate && typeof orderDate === 'object' && Object.keys(orderDate).length === 0) {
            orderDate = null;
          }
          
          const paymentStatus = o.paymentStatus || 'pending';
          const items = o.items || o.products || o.orderDetails || [];
          const orderAmount = o.orderAmount || o.total || o.amount || 0;

          console.log(`üìù Order ${orderId} extracted details:`, {
            orderId,
            userName,
            orderDate,
            paymentStatus,
            itemsCount: items.length,
            orderAmount
          });

          // Transform items if they are in a different format
          let processedItems = items;
          if (typeof items === 'string') {
            try { processedItems = JSON.parse(items); } catch (e) { processedItems = []; }
          }

          console.log(`üì¶ Order ${orderId} items processing:`, {
            originalItems: items,
            processedItems,
            processedItemsCount: processedItems.length
          });

          const itemRows = processedItems.length > 0 
            ? processedItems.map((item, itemIndex) => {
                try {
                  console.log(`üì¶ Building item row ${itemIndex + 1} for order ${orderId}:`, item);
                  const row = buildItemRow(item);
                  console.log(`‚úÖ Item row ${itemIndex + 1} built successfully`);
                  return row;
                } catch (itemError) {
                  console.error(`‚ùå Error building item row ${itemIndex + 1}:`, itemError, item);
                  return '<tr><td colspan="4" class="p-2 text-sm text-center text-red-500">Error displaying item</td></tr>';
                }
              }).join('') 
            : '<tr><td colspan="4" class="p-2 text-sm text-center text-gray-500">No items</td></tr>';

          console.log(`üì¶ Order ${orderId} item rows built:`, itemRows.substring(0, 100) + '...');

          // ‚úÖ FIXED: Status badge styling
          let statusClass = '';
          let statusText = paymentStatus || 'pending';
          
          if (statusText === 'paid' || statusText === 'completed') {
            statusClass = 'bg-green-100 text-green-700';
          } else if (statusText === 'failed' || statusText === 'cancelled') {
            statusClass = 'bg-red-100 text-red-700';
          } else {
            statusClass = 'bg-yellow-100 text-yellow-700';
          }

          console.log(`üé® Creating card for order ${orderId}...`);

          const card = document.createElement('div');
          card.className = 'bg-white border rounded shadow-sm p-4';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-sm text-gray-500">Order</div>
                <div class="text-lg font-semibold">#${escapeHtml(String(orderId))}</div>
                <div class="text-sm text-gray-600 mt-1">
                  ${escapeHtml(userName)}
                  ${userPhone ? ' ‚Ä¢ ' + escapeHtml(userPhone) : ''}
                </div>
                ${userEmail ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(userEmail)}</div>` : ''}
                ${userAddress ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(userAddress)}</div>` : ''}
              </div>

              <div class="text-right">
                <div class="text-sm text-gray-500">Placed</div>
                <div class="text-sm font-medium">${formatDate(orderDate)}</div>
                <div class="mt-2">
                  <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">
                    ${escapeHtml(statusText)}
                  </span>
                </div>
                <div class="text-lg font-bold text-gray-800 mt-2">
                  ${formatCurrency(orderAmount)}
                </div>
              </div>
            </div>

            <div class="mt-4 border rounded overflow-hidden">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-2 text-left">Product</th>
                    <th class="p-2 text-center">Qty</th>
                    <th class="p-2 text-right">Unit</th>
                    <th class="p-2 text-right">Line</th>
                  </tr>
                </thead>
                <tbody>${itemRows}</tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="p-2 text-right font-semibold">Total</td>
                    <td class="p-2 text-right font-semibold">${formatCurrency(orderAmount)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs text-gray-500">
                Order ID: ${escapeHtml(String(orderId))} ‚Ä¢ 
                Items: ${processedItems.length} ‚Ä¢ 
                Status: ${escapeHtml(statusText)}
              </div>
            </div>
          `;

          console.log(`üé® Appending card for order ${orderId} to container...`);
          container.appendChild(card);
          console.log(`‚úÖ Order ${orderId} rendered and appended successfully`);
          
        } catch (orderError) {
          console.error(`‚ùå Error rendering order ${index + 1}:`, orderError, o);
          console.error(`‚ùå Error stack:`, orderError.stack);
          
          // Create error card instead of failing completely
          const errorCard = document.createElement('div');
          errorCard.className = 'bg-red-50 border border-red-200 rounded p-4';
          errorCard.innerHTML = `
            <div class="text-red-700">
              <strong>Error displaying order ${index + 1}:</strong> ${orderError.message}
              <details class="mt-2">
                <summary class="cursor-pointer">Show order data</summary>
                <pre class="text-xs mt-2 bg-white p-2 rounded overflow-auto max-h-32">${JSON.stringify(o, null, 2)}</pre>
              </details>
            </div>
          `;
          container.appendChild(errorCard);
        }
      });

      console.log(`‚úÖ All orders processed. Total cards in container: ${container.children.length}`);
    }

    // placeholder - open a detailed modal or separate page for one order (optional)
    function openOrderDetail(orderId) {
      // Could open a modal; for now we navigate to deeper link
      window.location.href = `/admin/order-detail.html?orderId=${encodeURIComponent(orderId)}`;
    }

    async function handleMarkShipped(orderId) {
      if (!confirm('Mark order ' + orderId + ' as shipped?')) return;
      // call a server endpoint to update order status - adapt path to your API
      const res = await fetch(`${baseUrl}/api/admin/orders/mark-shipped`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
        body: JSON.stringify({ orderId })
      });
      const text = await res.text();
      let data; try { data = JSON.parse(text); } catch(e){ data = { text } }
      alert((data?.message) || (data?.error) || 'Action completed');
      loadOrders();
    }

    // initial load
    (function init() {
      if (!adminToken) {
        showLoginHint();
      }
      // if requestedUserId is present, prefill search and load
      if (requestedUserId) {
        document.getElementById('searchOrders').value = requestedUserId;
      }
      loadOrders();
    })();
  </script>
</body>
</html>